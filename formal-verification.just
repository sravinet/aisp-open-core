# Formal Verification Workflow for AISP
# Advanced justfile for formal methods validation

# Default formal verification workflow
default: setup-formal check-formal test-formal validate-formal

# â•â•â• FORMAL VERIFICATION SETUP â•â•â•

# Setup formal verification environment
setup-formal:
    @echo "ğŸ”§ Setting up formal verification environment..."
    @echo "ğŸ“‹ Checking Z3 installation..."
    @if ! command -v z3 >/dev/null 2>&1; then \
        echo "âŒ Z3 not found. Installing via Homebrew..."; \
        brew install z3; \
    else \
        echo "âœ… Z3 found: $(z3 --version)"; \
    fi
    @echo "ğŸ“‹ Checking environment variables..."
    @export LIBCLANG_PATH=/opt/homebrew/opt/llvm/lib
    @export Z3_SYS_Z3_HEADER=/opt/homebrew/include/z3.h
    @export C_INCLUDE_PATH=/opt/homebrew/include
    @export LIBRARY_PATH=/opt/homebrew/lib
    @export PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig
    @echo "âœ… Formal verification environment ready"

# â•â•â• COMPILATION FIXES â•â•â•

# Fix compilation errors systematically
fix-compilation:
    @echo "ğŸ”§ Fixing compilation errors..."
    @echo "Step 1: Fixing parser_new imports..."
    find core/crates/aisp-core/src -name "*.rs" -exec sed -i '' 's/parser_new::/parser::/g' {} \;
    @echo "Step 2: Fixing MetaBlock imports..."
    find core/crates/aisp-core/src -name "*.rs" -exec sed -i '' 's/use crate::parser::robust_parser::MetaBlock;/use crate::ast::canonical::MetaBlock;/g' {} \;
    @echo "Step 3: Adding missing module declarations..."
    @if ! grep -q "pub mod parser_new" core/crates/aisp-core/src/lib.rs; then \
        echo "parser_new module not needed - using consolidated parser"; \
    fi
    @echo "âœ… Compilation fixes applied"

# Check formal verification compilation
check-formal: fix-compilation
    @echo "ğŸ” Checking formal verification compilation..."
    LIBCLANG_PATH=/opt/homebrew/opt/llvm/lib \
    Z3_SYS_Z3_HEADER=/opt/homebrew/include/z3.h \
    C_INCLUDE_PATH=/opt/homebrew/include \
    LIBRARY_PATH=/opt/homebrew/lib \
    PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig \
    cargo check --lib --features z3-verification --message-format short

# â•â•â• FORMAL TESTING â•â•â•

# Test formal verification components
test-formal: check-formal
    @echo "ğŸ§ª Testing formal verification components..."
    @echo "Testing Z3 integration..."
    LIBCLANG_PATH=/opt/homebrew/opt/llvm/lib \
    Z3_SYS_Z3_HEADER=/opt/homebrew/include/z3.h \
    C_INCLUDE_PATH=/opt/homebrew/include \
    LIBRARY_PATH=/opt/homebrew/lib \
    PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig \
    cargo test --lib z3_verification::tests::test_z3_availability -- --nocapture

# Test mathematical verification
test-mathematical:
    @echo "ğŸ”¢ Testing mathematical verification..."
    LIBCLANG_PATH=/opt/homebrew/opt/llvm/lib \
    Z3_SYS_Z3_HEADER=/opt/homebrew/include/z3.h \
    C_INCLUDE_PATH=/opt/homebrew/include \
    LIBRARY_PATH=/opt/homebrew/lib \
    PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig \
    cargo test --lib mathematical_evaluator -- --nocapture

# Test semantic verification
test-semantic:
    @echo "ğŸ§  Testing semantic verification..."
    LIBCLANG_PATH=/opt/homebrew/opt/llvm/lib \
    Z3_SYS_Z3_HEADER=/opt/homebrew/include/z3.h \
    C_INCLUDE_PATH=/opt/homebrew/include \
    LIBRARY_PATH=/opt/homebrew/lib \
    PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig \
    cargo test --lib semantic_z3_verifier -- --nocapture

# â•â•â• DOCUMENT VALIDATION â•â•â•

# Validate AISP documents with formal verification
validate-formal: build-formal
    @echo "ğŸ“‹ Validating AISP documents with formal verification..."
    @echo "Testing valid minimal document..."
    ./target/debug/aisp-cli --level formal --format detailed validate tests/fixtures/valid/valid_minimal.aisp
    @echo "Testing all valid fixtures..."
    find tests/fixtures/valid -name "*.aisp" -exec ./target/debug/aisp-cli --level formal validate {} \;

# Create reference.md AISP translation
create-reference-aisp:
    @echo "ğŸ“ Creating AISP translation of reference.md..."
    @if [ ! -f "docs/examples/reference.aisp" ]; then \
        echo "Creating AISP version of reference document..."; \
        echo "ğ”¸5.1.reference@2026-01-30" > docs/examples/reference.aisp; \
        echo "Î³â‰”aisp.reference.specification" >> docs/examples/reference.aisp; \
        echo "Ïâ‰”âŸ¨foundation,architecture,features,validation,theoremsâŸ©" >> docs/examples/reference.aisp; \
        echo "âŠ¢NDâˆ§CATâˆ§Î Î£" >> docs/examples/reference.aisp; \
        echo "" >> docs/examples/reference.aisp; \
        echo "âŸ¦Î©:MetaâŸ§{" >> docs/examples/reference.aisp; \
        echo "  Visionâ‰œ\"Assembly language for AI cognition\"" >> docs/examples/reference.aisp; \
        echo "  Authorâ‰œ\"Bradley Ross\"" >> docs/examples/reference.aisp; \
        echo "  Affiliationâ‰œ\"Harvard ALM Digital Media Design\"" >> docs/examples/reference.aisp; \
        echo "  âˆ€DâˆˆAISP:Ambig(D)<0.02" >> docs/examples/reference.aisp; \
        echo "}" >> docs/examples/reference.aisp; \
        echo "" >> docs/examples/reference.aisp; \
        echo "âŸ¦Î£:TypesâŸ§{" >> docs/examples/reference.aisp; \
        echo "  Signalâ‰œV_HâŠ•V_LâŠ•V_S" >> docs/examples/reference.aisp; \
        echo "  V_Hâ‰œâ„â·â¶â¸; V_Lâ‰œâ„âµÂ¹Â²; V_Sâ‰œâ„Â²âµâ¶" >> docs/examples/reference.aisp; \
        echo "  ğ’«â‰œâŸ¨â„‹:Header,â„³:Membrane,ğ’©:NucleusâŸ©" >> docs/examples/reference.aisp; \
        echo "}" >> docs/examples/reference.aisp; \
        echo "" >> docs/examples/reference.aisp; \
        echo "âŸ¦Î“:RulesâŸ§{" >> docs/examples/reference.aisp; \
        echo "  âˆ€DâˆˆAISP:Ambig(D)<0.02" >> docs/examples/reference.aisp; \
        echo "  V_Hâˆ©V_Sâ‰¡âˆ…; V_Lâˆ©V_Sâ‰¡âˆ…; V_Hâˆ©V_Lâ‰¢âˆ…" >> docs/examples/reference.aisp; \
        echo "  âˆ€p:â„‹.id(p)â‰¡SHA256(ğ’©(p))" >> docs/examples/reference.aisp; \
        echo "}" >> docs/examples/reference.aisp; \
        echo "" >> docs/examples/reference.aisp; \
        echo "âŸ¦Î›:FunctionsâŸ§{" >> docs/examples/reference.aisp; \
        echo "  Ïˆ_gâ‰œÎ»b.Ïˆ_*âŠ–Ïˆ_have(b.G)" >> docs/examples/reference.aisp; \
        echo "  Î¼_fâ‰œÎ»x.Ïƒ(Î¸â‚Â·sim_H(x)+Î¸â‚‚Â·fit_L(x)+Î¸â‚ƒÂ·aff_M(x))" >> docs/examples/reference.aisp; \
        echo "  validateâ‰œâŒˆâŒ‰âˆ˜Î´âˆ˜Î“?âˆ˜âˆ‚" >> docs/examples/reference.aisp; \
        echo "}" >> docs/examples/reference.aisp; \
        echo "" >> docs/examples/reference.aisp; \
        echo "âŸ¦Î•âŸ§âŸ¨Î´â‰œ0.79;Ï†â‰œ97;Ï„â‰œâ—ŠâºâºâŸ©" >> docs/examples/reference.aisp; \
        echo "âœ… Created docs/examples/reference.aisp"; \
    else \
        echo "âœ… Reference AISP already exists"; \
    fi

# Validate reference AISP translation
validate-reference: create-reference-aisp build-formal
    @echo "ğŸ” Validating reference.aisp translation..."
    ./target/debug/aisp-cli --level formal --format detailed validate docs/examples/reference.aisp

# â•â•â• BUILD WORKFLOWS â•â•â•

# Build with formal verification features
build-formal: setup-formal check-formal
    @echo "ğŸ—ï¸ Building with formal verification..."
    LIBCLANG_PATH=/opt/homebrew/opt/llvm/lib \
    Z3_SYS_Z3_HEADER=/opt/homebrew/include/z3.h \
    C_INCLUDE_PATH=/opt/homebrew/include \
    LIBRARY_PATH=/opt/homebrew/lib \
    PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig \
    cargo build --features z3-verification

# â•â•â• VERIFICATION PIPELINE â•â•â•

# Complete formal verification pipeline
verify-pipeline: setup-formal fix-compilation check-formal test-formal create-reference-aisp validate-reference
    @echo "ğŸ¯ Formal verification pipeline complete!"
    @echo "âœ… Environment setup"
    @echo "âœ… Compilation fixes applied"
    @echo "âœ… Formal verification compilation"
    @echo "âœ… Formal verification tests"
    @echo "âœ… Reference AISP translation"
    @echo "âœ… Reference validation"
    @echo "ğŸ† All formal verification checks passed!"

# â•â•â• DEVELOPMENT WORKFLOWS â•â•â•

# Quick formal development cycle
dev-formal: fix-compilation check-formal test-mathematical
    @echo "âœ… Quick formal development cycle complete"

# Continuous verification monitoring
watch-formal:
    @echo "ğŸ‘€ Watching for formal verification changes..."
    cargo watch -x "test --lib z3_verification::tests" -x "test --lib mathematical_evaluator"

# â•â•â• PRODUCTION WORKFLOWS â•â•â•

# Production-ready formal verification build
prod-formal: setup-formal verify-pipeline
    @echo "ğŸš€ Building production formal verification..."
    LIBCLANG_PATH=/opt/homebrew/opt/llvm/lib \
    Z3_SYS_Z3_HEADER=/opt/homebrew/include/z3.h \
    C_INCLUDE_PATH=/opt/homebrew/include \
    LIBRARY_PATH=/opt/homebrew/lib \
    PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig \
    cargo build --release --features z3-verification

# â•â•â• DIAGNOSTICS â•â•â•

# Debug formal verification setup
debug-formal:
    @echo "ğŸ› Formal Verification Debug Report"
    @echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    @echo "Z3 Status:"
    @echo "  Binary: $(which z3 || echo 'Not found')"
    @echo "  Version: $(z3 --version || echo 'N/A')"
    @echo "  Headers: $(if [ -f /opt/homebrew/include/z3.h ]; then echo 'âœ… Found'; else echo 'âŒ Missing'; fi)"
    @echo "  libclang: $(if [ -f /opt/homebrew/opt/llvm/lib/libclang.dylib ]; then echo 'âœ… Found'; else echo 'âŒ Missing'; fi)"
    @echo ""
    @echo "Build Configuration:"
    @echo "  Features: z3-verification, verification, full"
    @echo "  Target: $(rustc --print target-triple)"
    @echo ""
    @echo "Test Status:"
    @cargo test --lib z3_verification::tests::test_z3_availability --features z3-verification 2>&1 | head -10 || echo "Test failed"

# Show formal verification statistics
stats-formal:
    @echo "ğŸ“Š Formal Verification Statistics"
    @echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    @echo "Z3 Integration Files:"
    find core/crates/aisp-core/src -name "*z3*" | wc -l
    @echo "Mathematical Verification Files:"
    find core/crates/aisp-core/src -name "*mathematical*" -o -name "*theorem*" -o -name "*proof*" | wc -l
    @echo "Semantic Verification Files:"
    find core/crates/aisp-core/src -name "*semantic*" | wc -l
    @echo "Test Coverage:"
    find core/crates/aisp-core/tests -name "*formal*" -o -name "*verification*" | wc -l